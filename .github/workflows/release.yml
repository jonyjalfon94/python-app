name: Release
on:
  push:
    branches:
      - main
jobs:
  release:
    runs-on: ubuntu-latest
    outputs:
      released: ${{ steps.release.outputs.releases_created }}
      tag: ${{ steps.release.outputs.tag_name }}
    steps:
      - uses: google-github-actions/release-please-action@v3
        id: release
        with:
          release-type: simple
          package-name: python-app

  build:
    needs: release
    if: ${{ needs.release.outputs.released }}
    permissions:
      id-token: write
      contents: read
    runs-on: ubuntu-latest
    env:
      SERVICE_NAME: python-demo-semantic
      PYTHON_VERSION: "3.9.6"
      POETRY_VERSION: "1.1.8"
    steps:
      # Workaround for running composite actions from private repo
      - name: Get composite run steps repository
        uses: actions/checkout@v2
        with:
          repository: jonyjalfon94/workflow-templates
          token: ${{ secrets.TOKEN }}
          path: .github

      # Get current date to pass as build-arg
      - name: Get current date
        shell: bash
        id: date
        run: echo "::set-output name=date::$(date +%Y-%m-%dT%H:%M:%S)"

      # Build and Push with Docker
      - uses: ./.github/actions/build-and-push-docker-2
        name: Build and Push Docker Image
        with:
          push: true
          target: production
          docker_username: jonyjalfon94
          docker_password: ${{ secrets.DOCKERHUB_PASSWORD }}
          image_name: ${{ env.SERVICE_NAME }}
          tag: ${{ needs.release.outputs.tag }}
          build_args: |
            SERVICE_COMMIT=${{ github.sha }}
            SERVICE_NAME=${{ env.SERVICE_NAME }}
            SERVICE_VERSION=${{ github.sha }}
            SERVICE_BUILD_TIME=${{ steps.date.outputs.date }}

      # Workaround for post action error
      - name: Get composite run steps repository
        uses: actions/checkout@v2
        with:
          repository: jonyjalfon94/workflow-templates
          token: ${{ secrets.TOKEN }}
          path: .github
